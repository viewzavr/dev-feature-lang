<!DOCTYPE html>
<html>
  <script src="./viewzavr-system-a/lib/viewlang/code/depends/jquery-2.1.4.js"></script>

  <script src="./viewzavr-system-a/lib/viewlang/code//depends/qmlweb/src/parser.js"></script>
  <script src="./viewzavr-system-a/lib/viewlang/code//depends/qmlweb/src/process.js"></script>
  <script src="./viewzavr-system-a/lib/viewlang/code//depends/qmlweb/src/import.js"></script>
  <script src="./viewzavr-system-a/lib/viewlang/code//depends/qmlweb/src/qtcore.js"></script>

  <script src="./viewzavr-system-a/lib/viewlang/code//base.js"></script>
<head>
</head>
<body>
  <div id="qmlSpace">
      target space for qml...
  </div>
  <style>
  #qmlSpace {
    width: 100vw !important;
    bottom: 0px !important;
    z-index: 10000;
  }
  .viewlang-canvas {
    width: 100%; height: 100%;
    margin: 0; padding: 0; display: block; left: 0px; top: 0px; position: absolute;
  }
  body { margin: 0; }
  </style>

  <script src="./viewzavr-system-a/lib/viewlang/code//threejs_driver/init.js"></script>

  <script type="module">

    ///////////////////////////// qmlweb and viewlang (required for viewzavr-system-a implementation)
    
    import * as Viewlang from "./viewzavr-system-a/lib/viewlang/code/embed2/init.js"
    window.qmlEngine = new QMLEngine( document.getElementById( "qmlSpace" ) );
    Viewlang.setup_qmlweb( qmlEngine );
    
    ///////////////////////////// viewzavr
    
    import * as Viewzavr from "./viewzavr-system-a/lib/viewzavr-core/init.js";

    var vz = Viewzavr.create();
    // window.vz = vz;
    
    //////////////////////////// player
    
    import * as Player from "./viewzavr-system-a/player/init.js";
    var vzPlayer = Player.create( vz, qmlEngine );
    window.vzPlayer = vzPlayer;
    vzPlayer.feature("switch_to_editor_kbd switch_to_editor_link");
    
    //////////////////////////// graphical api
    import * as VisAPI from "./viewzavr-system-a/graphical-api/init.js";
    VisAPI.setup( vz );

    //////////////////////////// feature lang
    import * as compomachine from "./compolang/machine.js";
    compomachine.setup( vz, compomachine );
    
    var q = vzPlayer.loadEmptyScene();
    var file = getParameterByName("src") || (vz.getDir( import.meta.url ) + "code.txt" );
    var filedir = vz.getDir( file );
    
    //var obj = vz.createObjByType( "compolang_machine", {parent:vzPlayer.getRoot()})
    //var obj = vz.createObj( {parent:vzPlayer.getRoot(),features:"compolang_machine",name:"compolang_machine"})
    //var obj = vzPlayer.getRoot().create_obj({},{features:"compolang_machine",name:"compolang_machine"})
    //var obj = vzPlayer.getRoot().env({features:"compolang_machine",name:"compolang_machine"})
    var obj = vzPlayer.getRoot();
    obj.feature("compolang_machine");

    var htmldir = vz.getDir(import.meta.url)  
    vzPlayer.loadPackage( htmldir + "./viewzavr-system-a/features/list.txt" ).then( () => {
    
    vzPlayer.addPackage( {code:"lib3d",url:(htmldir + "./libs/lib3d/lib3d.js")});
    vzPlayer.addPackage( {code:"csv",url:(htmldir + "./libs/csv/features.js")});

    //vzPlayer.addPackage( {code:"basic",url:(htmldir + "./libs/basic/basic.js")});
    
    //vzPlayer.addPackage( {code:"params",url:(htmldir + "./libs/params/params.cl")});
    vzPlayer.feature("register_compolang_func");
    vzPlayer.register_compalang( "params",(htmldir + "./libs/params/params.cl"));

    // короче идея такая что загружать из стандартного чего-то типа list.txt или еще что
    // а то получается знание из пакета кочует сюда и это коряво. пусть пакет живет в папке, это можно пережить..
    // например как альтернативный вариант..
    vzPlayer.register_compalang( "gui",(htmldir + "./libs/gui/init.cl"));
    vzPlayer.register_compalang( "io",(htmldir + "./libs/io/init.cl"));
    vzPlayer.register_compalang( "render-params",(htmldir + "./libs/render-params/init.cl"));

    fetch( file ).then( (res) => res.text() ).then( (txt) => {
        obj.setParam("base_url",filedir);
        obj.setParam("text",txt);

        /*
        var obj = vzPlayer.getRoot();
        obj.feature("simple-lang");
        // здесь я чувствую что фича это тупо.. как было бы проще выдавать просто env.parse..
        // но это по сути require, по своей сути, получается... ну глянем на язык еще
        obj.parseSimpleLang( txt, {base_url: filedir} );
        */

        //obj.feature("timers")
        setTimeout( () => {
          vzPlayer.loadFromHash();
          vzPlayer.startSavingToHash();
        },500);

    });

    });

  </script>

</body>
