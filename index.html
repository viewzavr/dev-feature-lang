<!DOCTYPE html>
<html>
<head>
</head>
<body>

  <style>
  .viewlang-canvas {
    width: 100%; height: 100%;
    margin: 0; padding: 0; display: block; left: 0px; top: 0px; position: absolute;
  }
  body { margin: 0; }
  </style>

<!--
  <script src="./viewzavr-system-a/lib/viewlang/code//threejs_driver/init.js"></script>
  <script src="//unpkg.com/3d-force-graph@1.70.5/dist/3d-force-graph.js"></script>

  <script src="libs/scene-explorer-3d/3d-force-graph.js"></script>
  <script src="libs/scene-explorer-3d/three-spritetext.js"></script>
-->    

  <script type="module">

    ///////////////////////////// qmlweb and viewlang (required for viewzavr-system-a implementation)
    
//    import * as Viewlang from "./viewzavr-system-a/lib/viewlang/code/embed2/init.js"
//    window.qmlEngine = new QMLEngine( document.getElementById( "qmlSpace" ) );
//    Viewlang.setup_qmlweb( qmlEngine );
    
    ///////////////////////////// viewzavr
    
    import * as Viewzavr from "./viewzavr-system-a/lib/viewzavr-core/init.js";

    var vz = Viewzavr.create();
    // window.vz = vz;
    
    //////////////////////////// player

/*    
    import * as Player from "./viewzavr-system-a/player/init.js";
    var vzPlayer = Player.create( vz );
    window.vzPlayer = vzPlayer;
*/    
    // vzPlayer.feature("switch_to_editor_kbd switch_to_editor_link");
    
    //////////////////////////// graphical api
    //import * as VisAPI from "./viewzavr-system-a/graphical-api/init.js";
    //VisAPI.setup( vz );

    //////////////////////////// feature lang
    import * as compomachine from "./compolang/machine.js";
    compomachine.setup( vz, compomachine );

    import * as packages_api from "./player-stuff/packages-api.js";
    packages_api.setup( vz, packages_api );
    import * as save_state_to_window_hash from "./player-stuff/window-hash-p.js";
    save_state_to_window_hash.setup( vz, save_state_to_window_hash );
    import * as timers from "./player-stuff/timers.js";
    timers.setup( vz, timers );    
    
    //var q = vzPlayer.loadEmptyScene();
    
    //var obj = vz.createObjByType( "compolang_machine", {parent:vzPlayer.getRoot()})
    //var obj = vz.createObj( {parent:vzPlayer.getRoot(),features:"compolang_machine",name:"compolang_machine"})
    //var obj = vzPlayer.getRoot().create_obj({},{features:"compolang_machine",name:"compolang_machine"})
    //var obj = vzPlayer.getRoot().env({features:"compolang_machine",name:"compolang_machine"})
    //var obj = vzPlayer.getRoot();
    var vzPlayer = vz.createObj();
    window.vzPlayer = vzPlayer;
    
    vzPlayer.feature("packages_load packages_table save_state_to_window_hash");

    var htmldir = vz.getDir(import.meta.url)  
//    vzPlayer.loadPackage( htmldir + "./viewzavr-system-a/features/list.txt" ).then( () => {

    //vzPlayer.feature("switch_to_editor_kbd switch_to_editor_link");
    
    vzPlayer.addPackage( {code:"lib3d",url:(htmldir + "./libs/lib3d/lib3d.js")});
    vzPlayer.addPackage( {code:"csv",url:(htmldir + "./libs/csv/features.js")});

    //vzPlayer.addPackage( {code:"basic",url:(htmldir + "./libs/basic/basic.js")});
    
    //vzPlayer.addPackage( {code:"params",url:(htmldir + "./libs/params/params.cl")});
    vzPlayer.feature("register_compolang_func");
    vzPlayer.register_compalang( "params",(htmldir + "./libs/params/params.cl"));

    // короче идея такая что загружать из стандартного чего-то типа list.txt или еще что
    // а то получается знание из пакета кочует сюда и это коряво. пусть пакет живет в папке, это можно пережить..
    // например как альтернативный вариант..
    vzPlayer.register_compalang( "gui",(htmldir + "./libs/gui/init.cl"));
    vzPlayer.register_compalang( "io",(htmldir + "./libs/io/init.cl"));
    vzPlayer.register_compalang( "render-params",(htmldir + "./libs/render-params/init.cl"));

    vzPlayer.register_compalang( "lib3dv2",(htmldir + "./libs/lib3dv2/init.cl"));
    vzPlayer.register_compalang( "lib3dv3",(htmldir + "./libs/lib3dv3/init.cl"));
    vzPlayer.register_compalang( "df",(htmldir + "./libs/df/init.cl"));
    vzPlayer.register_compalang( "misc",(htmldir + "./libs/misc/init.cl"));
    vzPlayer.register_compalang( "svg",(htmldir + "./libs/svg/init.cl"));
    vzPlayer.register_compalang( "set-params",(htmldir + "./libs/set-params/init.cl"));
    vzPlayer.register_compalang( "new-modifiers",(htmldir + "./libs/new-modifiers/init.cl"));
    vzPlayer.register_compalang( "imperative",(htmldir + "./libs/imperative/init.cl"));

    vzPlayer.register_compalang( "scene-explorer-3d",(htmldir + "./libs/scene-explorer-3d/init.cl"));
    vzPlayer.register_compalang( "56view",(htmldir + "./libs/56view/init.cl"));


    ////////////////////////////
   function getParameterByName(name) 
   {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
      
      return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, " "));
    };

    var file = getParameterByName("src") || (vz.getDir( import.meta.url ) + "code.txt" );
    var filedir = vz.getDir( file );
    //console.log( file,filedir)
    //debugger;

    fetch( file ).then( (res) => res.text() ).then( (txt) => {
        //console.log(txt)
        let obj = vz.createObj();
        window.vzRoot = obj; // ну это нам для консоли
        obj.feature("compolang_machine");
        obj.setParam("base_url",filedir);
        obj.setParam("diag_file", file );
        obj.setParam("text",txt);

        /*
        var obj = vzPlayer.getRoot();
        obj.feature("simple-lang");
        // здесь я чувствую что фича это тупо.. как было бы проще выдавать просто env.parse..
        // но это по сути require, по своей сути, получается... ну глянем на язык еще
        obj.parseSimpleLang( txt, {base_url: filedir} );
        */

        //obj.feature("timers")

        // типа оно не сразу отработает, на это одна надежда
        // но вообще надо нормальный метод с промисом. 
        // потому что нам и отработать надо 1 раз всего..

        obj.on("done",(res) => {
          //console.log("done catched",res)

          obj.delayed( () => {
            //console.log("global: issuing load from hash");
            vzPlayer.loadFromHash(obj).then( () => {
              // console.log("restored. emitting global dump-loaded");
              // vzPlayer.getRoot().emit("dump-loaded");
              //vzPlayer.getRoot().setParam("dump_loaded",true);
              vzPlayer.setParam( "dump_loaded",true );
              vzPlayer.startSavingToHash(obj);
            })
          },2)(); // все ссылки отработают (им нужен 1 такт)
          // но хотя и это спорно
          
        });

    });

    //});

  </script>

</body>
